#!/bin/bash
set -e

if [[ ! -v APPLI_APACHE_SERVERNAME ]]; then
  echo "Missing env: APPLI_APACHE_SERVERNAME"
  exit 1
fi
if [[ ! -v APPLI_APACHE_SERVERADMIN ]]; then
  echo "Missing env: APPLI_APACHE_SERVERADMIN"
  exit 1
fi
if [[ ! -v APPLI_APACHE_LOGLEVEL ]]; then
  echo "Missing env: APPLI_APACHE_LOGLEVEL"
  exit 1
fi

# Allow shibboleth to write in a mounted volume
chown -R _shibd:_shibd /var/cache/shibboleth

# patch shibboleth2.xml config file with SP/DS URLs
sed -e "s|{{SHIBBOLETH_SP_URL}}|${SHIBBOLETH_SP_URL:-http://www.example.com}|" \
    -e "s|{{SHIBBOLETH_DS_URL}}|${SHIBBOLETH_DS_URL:-http://www.example.com}|" \
    /etc/shibboleth/shibboleth2.dist.xml > /etc/shibboleth/shibboleth2.xml

if [[ -z "$EZMESURE_DISABLE_SHIBBOLETH" ]]; then
  if [[ ! -v SHIBBOLETH_SP_URL ]]; then
    echo "Missing env: SHIBBOLETH_SP_URL"
    exit 1
  fi
  if [[ ! -v SHIBBOLETH_DS_URL ]]; then
    echo "Missing env: SHIBBOLETH_DS_URL"
    exit 1
  fi

  /etc/init.d/shibd start
fi

# Apache gets grumpy about pre-existing PID files
rm -f /var/run/apache2/apache2.pid

exec apachectl -DFOREGROUND
